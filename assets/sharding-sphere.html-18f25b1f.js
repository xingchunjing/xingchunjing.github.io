import{_ as i,X as c,Y as o,Z as n,$ as s,a0 as a,a1 as u,a4 as p,E as t}from"./framework-a5b3b151.js";const r={},d=n("h1",{id:"数据库中间件",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#数据库中间件","aria-hidden":"true"},"#"),s(" 数据库中间件")],-1),k=n("p",null,"Apache ShardingSphere 是一款分布式的数据库生态系统，可以将任意数据库转换为分布式数据库，并通过数据分片、弹性伸缩、加密等能力对原有数据库进行增强。",-1),m={href:"https://shardingsphere.apache.org/index_zh.html",target:"_blank",rel:"noopener noreferrer"},v=p('<p>Apache ShardingSphere 由 ShardingSphere-JDBC 和 ShardingSphere-Proxy 这 2 款既能够独立部署，又支持混合部署配合使用的产品组成。</p><table><thead><tr><th style="text-align:left;"></th><th style="text-align:left;">ShardingSphere-JDBC</th><th style="text-align:left;">ShardingSphere-Proxy</th></tr></thead><tbody><tr><td style="text-align:left;">数据库</td><td style="text-align:left;">任意</td><td style="text-align:left;">MySQL/PostgreSQL</td></tr><tr><td style="text-align:left;">连接消耗数</td><td style="text-align:left;">高</td><td style="text-align:left;">低</td></tr><tr><td style="text-align:left;">异构语言</td><td style="text-align:left;">仅</td><td style="text-align:left;">Java</td></tr><tr><td style="text-align:left;">性能</td><td style="text-align:left;">损耗低</td><td style="text-align:left;">损耗略高</td></tr><tr><td style="text-align:left;">无中心化</td><td style="text-align:left;">是</td><td style="text-align:left;">否</td></tr><tr><td style="text-align:left;">静态入口</td><td style="text-align:left;">无</td><td style="text-align:left;">有</td></tr></tbody></table>',2),b=p(`<h2 id="maven依赖" tabindex="-1"><a class="header-anchor" href="#maven依赖" aria-hidden="true">#</a> Maven依赖</h2><p>这个版本变动很大，不同的版本的配置参数有些不同，版本升级的话可能会遇到各种错误 这里先不贴出maven的依赖了，继续向下看，后面会做详细说明，不同的版本配置不相同，稍微动一下就可能出现很多错误，所以后续会把不同的版本可能遇到的问题全部贴一下</p><div class="hint-container danger"><p class="hint-container-title">重要</p><p>配置简单，出错也很容易，版本，配置</p></div><h2 id="数据分片" tabindex="-1"><a class="header-anchor" href="#数据分片" aria-hidden="true">#</a> 数据分片</h2><p>配置数据分片规则：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span> <span class="token comment"># 数据分片规则配置</span>
      <span class="token key atrule">t_order</span><span class="token punctuation">:</span> <span class="token comment"># 逻辑表名称（也就是想要分片的表名）</span>
        <span class="token comment"># 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}</span>
        <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span> <span class="token comment"># 由数据源名 + 表名组成（参考 Inline 语法规则）</span>
        <span class="token comment"># 拆分库策略，也就是什么样子的数据放入放到哪个数据库中。standard，complex，hint，none只能选其中一个</span>
        <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span> <span class="token comment"># 分库策略，缺省表示使用默认分库策略，以下的分片策略只能选其一</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span> <span class="token comment"># 用于单分片键的标准分片场景</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id    <span class="token comment"># 分片字段（分片键）# 分片列名称</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> database<span class="token punctuation">-</span>inline <span class="token comment"># 分片算法名称，这个名称需要对应配置sharding-algorithms.database-inline，算法名称可随意定义，这个会有问题，后续说明</span>
          <span class="token key atrule">complex</span><span class="token punctuation">:</span> <span class="token comment"># 用于多分片键的复合分片场景</span>
            <span class="token key atrule">shardingColumns</span><span class="token punctuation">:</span> <span class="token comment"># 分片列名称，多个列以逗号分隔</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> <span class="token comment"># 分片算法名称</span>
          <span class="token key atrule">hint</span><span class="token punctuation">:</span> <span class="token comment"># Hint 分片策略</span>
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> <span class="token comment"># 分片算法名称</span>
          <span class="token key atrule">none</span><span class="token punctuation">:</span> <span class="token comment"># 不分片</span>
        <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span> <span class="token comment"># 分表策略，同分库策略</span>
        <span class="token key atrule">keyGenerateStrategy</span><span class="token punctuation">:</span> <span class="token comment"># 分布式序列策略</span>
          <span class="token key atrule">column</span><span class="token punctuation">:</span> <span class="token comment"># 自增列名称，缺省表示不使用自增主键生成器</span>
          <span class="token key atrule">keyGeneratorName</span><span class="token punctuation">:</span> <span class="token comment"># 分布式序列算法名称</span>
        <span class="token key atrule">auditStrategy</span><span class="token punctuation">:</span> <span class="token comment"># 分片审计策略</span>
          <span class="token key atrule">auditorNames</span><span class="token punctuation">:</span> <span class="token comment"># 分片审计算法名称</span>
            <span class="token punctuation">-</span> &lt;auditor_name<span class="token punctuation">&gt;</span>
            <span class="token punctuation">-</span> &lt;auditor_name<span class="token punctuation">&gt;</span>
          <span class="token key atrule">allowHintDisable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否禁用分片审计hint</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container danger"><p class="hint-container-title">警告</p><p>shardingAlgorithmName: database-inline这个参数可以出现问题，后续说明</p></div><p>配置默认分裤规则</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">#可不配置</span>
<span class="token key atrule">default-database-strategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">none</span><span class="token punctuation">:</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置默认分表规则</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">#可不配置</span>
<span class="token key atrule">default-sharding-column</span><span class="token punctuation">:</span> <span class="token comment"># 默认分片列名称，可不配置</span>
<span class="token key atrule">default-database-strategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">none</span><span class="token punctuation">:</span> <span class="token comment">#可不配置</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>绑定表，避免出现避免JOIN 笛卡尔积</p><p>在关联查询的时候，有可能出现多条交错的查询</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> a<span class="token punctuation">.</span>id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>order_id <span class="token keyword">from</span> t_order_0 a <span class="token keyword">inner</span> <span class="token keyword">join</span> t_order_info b <span class="token keyword">on</span> a<span class="token punctuation">.</span>order_id <span class="token operator">=</span> b<span class="token punctuation">.</span>order_id <span class="token keyword">where</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">select</span> a<span class="token punctuation">.</span>id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>order_id <span class="token keyword">from</span> t_order_1 a <span class="token keyword">inner</span> <span class="token keyword">join</span> t_order_info b <span class="token keyword">on</span> a<span class="token punctuation">.</span>order_id <span class="token operator">=</span> b<span class="token punctuation">.</span>order_id <span class="token keyword">where</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了避免上述现象可以添加绑定表</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">binding-tables</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> t_order<span class="token punctuation">,</span>t_order_info
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>广播表配置 广播的特点是所有的接收端就能收到。所以对于这里的广播表的概念就是插入数据所有的节点都能获取到同样的数据;</p><p>一般用到比如数据字典等数据量不到，但是所有数据源都需要有相同的数据的场景</p><p>一个表配置成广播表是一定不分片的</p><p>插入时，向所有数据源广播发送sql语句</p><p>查询时，只查询其中的一个数据源</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">broadcastTables</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> t_config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>对于用户的登陆表之类的数据量比较大的表而且信息还需要长时间保存完整可采用下面配置，需要注意一下多个参数分表与一个参数分表有些不同</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">t_log</span><span class="token punctuation">:</span>
  <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_log_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>2020..2021<span class="token punctuation">}</span>_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>1..12<span class="token punctuation">}</span>_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>1..31<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div><h2 id="重点介绍-版本配置" tabindex="-1"><a class="header-anchor" href="#重点介绍-版本配置" aria-hidden="true">#</a> 重点介绍(版本配置)</h2><h3 id="低版本4-0-0-rc1" tabindex="-1"><a class="header-anchor" href="#低版本4-0-0-rc1" aria-hidden="true">#</a> 低版本4.0.0-RC1</h3><p>这个是最简单的，不用修改代码本身的逻辑，也不用修改代码本身的maven依赖，只需要引入一个新的maven依赖和配置一下配置文件即可</p><div class="hint-container tip"><p class="hint-container-title">提示</p><ul><li>添加maven依赖</li><li>添加ymal配置</li></ul><p>所有的其他的相关的配置均不需要修改，博主本身用到的相关配置这里介绍一下</p><p>数据库驱动</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.47<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>连接池</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Mybatis-Plus</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Spring Boot</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.2.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>数据库库和表(通用，后续不做重复介绍)</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>

test_demo_0
test_demo_1

<span class="token keyword">use</span> test_demo_0<span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span>

t_order_0
t_order_1

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>t_order_0<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>order_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实体类(通用，后续不做重复介绍)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;t_order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderInfo</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@TableId</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> orderId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>@TableName(&quot;t_order&quot;)和分片时候的表名一致，</p><p>如果不加该注解也可以将类名与分片表名一致：例t_order==TOrder</p></div><p>maven依赖（新增）:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-jdbc-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0.0-RC1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>yaml配置，可以直接新建application-low.yml，直接按照下面示例配置即可</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment">#一个实体类对应多张表，覆盖，不然启动报错</span>
  <span class="token key atrule">sharding-sphere</span><span class="token punctuation">:</span> <span class="token comment"># Sharding-JDBC的配置</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token comment"># 数据源（逻辑名字）# 给每个数据源取别名，下面的ds0,ds1任意取名字</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> ds0<span class="token punctuation">,</span>ds1
      <span class="token comment"># 配置数据源# 每个数据源配置数据库连接信息</span>
      <span class="token key atrule">ds0</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test_demo_0<span class="token punctuation">?</span>characterEncoding=utf8<span class="token important">&amp;useSSL=true&amp;createDatabaseIfNotExist=true&amp;serverTimezone=GMT&amp;nullNamePatternMatchesAll=true</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
      <span class="token key atrule">ds1</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/test_demo_1<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
    <span class="token comment"># 分片的配置</span>
    <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
      <span class="token comment"># 表的分片策略</span>
      <span class="token key atrule">tables</span><span class="token punctuation">:</span>
        <span class="token comment"># 逻辑表的名称,# t_order 逻辑表名,数据库中需要分表操作的表名，如果不需要做分表操作，走default-table-strategy:</span>
        <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
          <span class="token comment"># 数据节点配置，采用Groovy表达式,数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}</span>
          <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
          <span class="token comment"># 配置策略</span>
          <span class="token key atrule">table-strategy</span><span class="token punctuation">:</span>
            <span class="token comment"># 精确匹配</span>
            <span class="token key atrule">inline</span><span class="token punctuation">:</span>
              <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> order_id
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> t_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>order_id % 2<span class="token punctuation">}</span>
          <span class="token key atrule">database-strategy</span><span class="token punctuation">:</span>
            <span class="token comment"># 精确匹配</span>
            <span class="token key atrule">inline</span><span class="token punctuation">:</span>
              <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> id
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>id % 2<span class="token punctuation">}</span>
          <span class="token comment"># 主键生成策略</span>
          <span class="token key atrule">key-generator</span><span class="token punctuation">:</span>
            <span class="token comment"># 主键</span>
            <span class="token key atrule">column</span><span class="token punctuation">:</span> id
            <span class="token comment"># 雪花算法</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE
    <span class="token key atrule">props</span><span class="token punctuation">:</span> <span class="token comment"># 日志显示具体的SQL</span>
      <span class="token key atrule">sql</span><span class="token punctuation">:</span>
        <span class="token key atrule">show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>直接将主配置文件修改启用文件即可 例(后续通用)：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8089</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /jingxc/sharding/sphere
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> low
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> jingxc<span class="token punctuation">-</span>boot<span class="token punctuation">-</span>sharding<span class="token punctuation">-</span>sphere
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mapper/<span class="token important">*.xml</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.0.0-RC1到这就配置完成，与原有项目能很快融入使用</p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>如果启动报错</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Description:

The bean &#39;dataSource&#39;, defined in class path resource [org/apache/shardingsphere/shardingjdbc/spring/boot/SpringBootConfiguration.class], could not be registered. A bean with that name has already been defined in class path resource [com/alibaba/druid/spring/boot/autoconfigure/DruidDataSourceAutoConfigure.class] and overriding is disabled.

Action:

Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>按照提示添加</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>spring:
  main:
    allow-bean-definition-overriding: true  #一个实体类对应多张表，覆盖，不然启动报错
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>暂没遇到其他错误</p><h3 id="升级4-1-1" tabindex="-1"><a class="header-anchor" href="#升级4-1-1" aria-hidden="true">#</a> 升级4.1.1</h3><p>maven依赖（新增）:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-jdbc-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container danger"><p class="hint-container-title">警告</p><p>启动报错</p><p>Invocation of init method failed; nested exception is java.lang.IllegalArgumentException: Property &#39;sqlSessionFactory&#39; or &#39;sqlSessionTemplate&#39; are required</p></div><p>这是连接池的版本依赖问题，</p><p>不要使用druid-spring-boot-starter这个依赖</p><p>解决方案 去掉druid-spring-boot-starter这个Spring Boot的依赖，使用单独的链接池</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="升级5-1-1" tabindex="-1"><a class="header-anchor" href="#升级5-1-1" aria-hidden="true">#</a> 升级5.1.1</h3><p>4.X和5.X的maven依赖不一样了，配置也做了改动，首先maven依赖不再是之前的artifactId</p><p>maven依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.shardingsphere/shardingsphere-jdbc-core-spring-boot-starter --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shardingsphere-jdbc-core-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container danger"><p class="hint-container-title">警告</p><p>启动报错</p><p>Error creating bean with name &#39;org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaConfiguration&#39;: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;dataSource&#39; defined in class path resource [org/apache/shardingsphere/spring/boot/ShardingSphereAutoConfiguration.class]: Unsatisfied dependency expressed through method &#39;dataSource&#39; parameter 0; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type &#39;org.apache.shardingsphere.infra.config.mode.ModeConfiguration&#39; available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}</p></div><p>这是由于配置文件的配置有关</p><p>在sharding前加rules:<br> sharding:整体后移 其他均不变</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 分片的配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">sharding-sphere</span><span class="token punctuation">:</span> <span class="token comment"># Sharding-JDBC的配置</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
        <span class="token comment"># 表的分片策略</span>
        <span class="token key atrule">tables</span><span class="token punctuation">:</span>
          <span class="token comment"># 逻辑表的名称,# t_order 逻辑表名,数据库中需要分表操作的表名，如果不需要做分表操作，走default-table-strategy:</span>
          <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container danger"><p class="hint-container-title">警告</p><p>执行sql语句报错</p><p>Cause: java.lang.IllegalStateException: Insert statement does not support sharding table routing to multiple data nodes.] with root cause</p></div><p>这个是由于分片的时候规则有问题 需要使用sharding-algorithms:</p><p>也就是说需要单独设置分片规则 改动地方较大，这里直接展出最后结果</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token comment"># 是否开启</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token comment"># 数据源（逻辑名字）</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> m0<span class="token punctuation">,</span>m1
      <span class="token comment"># 配置数据源</span>
      <span class="token key atrule">m0</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test_demo_0<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
      <span class="token key atrule">m1</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test_demo_1<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
    <span class="token comment"># 分片的配置</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
        <span class="token comment"># 表的分片策略</span>
        <span class="token key atrule">tables</span><span class="token punctuation">:</span>
          <span class="token comment"># 逻辑表的名称</span>
          <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
            <span class="token comment"># 数据节点配置，采用Groovy表达式</span>
            <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> m$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
            <span class="token comment"># 配置策略</span>
            <span class="token key atrule">table-strategy</span><span class="token punctuation">:</span>
              <span class="token comment"># 用于单分片键的标准分片场景</span>
              <span class="token key atrule">standard</span><span class="token punctuation">:</span>
                <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> order_id
                <span class="token comment"># 分片算法名字</span>
                <span class="token key atrule">sharding-algorithm-name</span><span class="token punctuation">:</span> t<span class="token punctuation">-</span>order
            <span class="token key atrule">key-generate-strategy</span><span class="token punctuation">:</span> <span class="token comment"># 主键生成策略</span>
              <span class="token key atrule">column</span><span class="token punctuation">:</span> id  <span class="token comment"># 主键列</span>
              <span class="token key atrule">key-generator-name</span><span class="token punctuation">:</span> snowflake  <span class="token comment"># 策略算法名称(推荐使用雪花算法)</span>
        <span class="token key atrule">defaultDatabaseStrategy</span><span class="token punctuation">:</span>
          <span class="token key atrule">standard</span><span class="token punctuation">:</span>
            <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id
            <span class="token key atrule">shardingAlgorithmName</span><span class="token punctuation">:</span> database<span class="token punctuation">-</span>inline
        <span class="token key atrule">key-generators</span><span class="token punctuation">:</span>
          <span class="token key atrule">snowflake</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE
        <span class="token key atrule">sharding-algorithms</span><span class="token punctuation">:</span>
          <span class="token key atrule">database-inline</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
            <span class="token key atrule">props</span><span class="token punctuation">:</span>
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> m$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>id % 2<span class="token punctuation">}</span>
          <span class="token key atrule">t-order</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
            <span class="token key atrule">props</span><span class="token punctuation">:</span>
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> t_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>order_id % 2<span class="token punctuation">}</span>
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token comment"># 日志显示具体的SQL</span>
      <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置的时候需要注意如果出现</p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>org.apache.shardingsphere.spi.exception.ServiceProviderNotFoundException: No implementation class load from SPI <code>org.apache.shardingsphere.sharding.spi.KeyGenerateAlgorithm</code> with type <code>null</code>.</p></div><p>这个是配置的空格有问题，导致启动的时候出现某些参数为空，仔细检查空格，yml就是有这一点不好</p><p>如果出现</p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;org.apache.shardingsphere.spring.boot.ShardingSphereAutoConfiguration&#39;: Initialization of bean failed; nested exception is java.lang.NoClassDefFoundError: org/apache/tomcat/dbcp/dbcp2/BasicDataSource</p></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>网上有说需要加</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tomcat-dbcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>10.0.16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里确实可以解决上面那个报错，但这不是主要问题，根源不在这，先加上这个依赖试一下</p></div><p>出现报错：</p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &#39;org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaConfiguration&#39;: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;shardingSphereDataSource&#39; defined in class path resource [org/apache/shardingsphere/spring/boot/ShardingSphereAutoConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [javax.sql.DataSource]: Factory method &#39;shardingSphereDataSource&#39; threw exception; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;shardingRuleConfiguration&#39; defined in class path resource [org/apache/shardingsphere/sharding/spring/boot/ShardingRuleSpringBootConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.shardingsphere.infra.config.RuleConfiguration]: Factory method &#39;shardingRuleConfiguration&#39; threw exception; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;table_inline&#39;: Initialization of bean failed; nested exception is java.lang.IllegalStateException: Inline sharding algorithm expression cannot be null or empty.</p></div><p>table_inline这是分片名称，和上面t-order是一个东西，这个可以《随便》定义</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>这个就是由于下划线引起的，去掉下划线或者改成中华线即可</p><p>例：table-inline</p></div><div class="hint-container danger"><p class="hint-container-title">警告</p><p>如果运行出现</p><p>Parameter index out of range (1 &gt; number of parameters, which is 0).; nested exception is java.sql.SQLException: Parameter index out of range (1 &gt; number of parameters, which is 0).] with root cause</p><p>或者 SQL: INSERT INTO t_order ( id, order_no, user_id, amount ) VALUES ( ?, ?, ?, ? )</p><h3 id="cause-java-sql-sqlsyntaxerrorexception-table-test-demo-0-t-order-doesn-t-exist" tabindex="-1"><a class="header-anchor" href="#cause-java-sql-sqlsyntaxerrorexception-table-test-demo-0-t-order-doesn-t-exist" aria-hidden="true">#</a> Cause: java.sql.SQLSyntaxErrorException: Table &#39;test_demo_0.t_order&#39; doesn&#39;t exist</h3></div><p>那一定是配置有问题，和依赖没多大关系</p><ul><li>检查空格</li><li>检查字段名称</li><li>检查实体类</li></ul><p>空格好好检查</p><p>字段需要注意：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
    <span class="token comment"># 表的分片策略</span>
    <span class="token key atrule">tables</span><span class="token punctuation">:</span>
      <span class="token comment"># 逻辑表的名称,注意注意再注意</span>
      <span class="token key atrule">t_order</span><span class="token punctuation">:</span>
        <span class="token comment"># 数据节点配置，采用Groovy表达式,注意注意再注意</span>
        <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> m$<span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.t_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>


<span class="token key atrule">sharding-algorithms</span><span class="token punctuation">:</span>
  <span class="token key atrule">database-inline</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> m$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>id % 2<span class="token punctuation">}</span>
  <span class="token key atrule">table-inline</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token comment"># 注意注意再注意</span>
      <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> t_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>order_id % 2<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实体类检查</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;t_order&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//要不添加@TableName注解，要不注意类名，注意注意再注意</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderInfo</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@TableId</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> orderId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>暂时还没发现其他问题，如果按照上面的都走了一遍没啥问题，就可以去掉<code>tomcat-dbcp</code>这个依赖了</p><h3 id="升级5-2-1" tabindex="-1"><a class="header-anchor" href="#升级5-2-1" aria-hidden="true">#</a> 升级5.2.1</h3><div class="hint-container danger"><p class="hint-container-title">警告</p><p>如果出现</p><p>Description:</p><p>An attempt was made to call a method that does not exist. The attempt was made from the following location:</p><pre><code>org.apache.shardingsphere.infra.util.yaml.constructor.ShardingSphereYamlConstructor$1.&lt;init&gt;(ShardingSphereYamlConstructor.java:44)
</code></pre><p>The following method did not exist:</p><pre><code>&#39;void org.apache.shardingsphere.infra.util.yaml.constructor.ShardingSphereYamlConstructor$1.setCodePointLimit(int)&#39;
</code></pre><p>The calling methods class, org.apache.shardingsphere.infra.util.yaml.constructor.ShardingSphereYamlConstructor$1, was loaded from the following location:</p></div><p>snakeyaml的版本冲突,使用的版本中LoaderOptions没有setCodePointLimit这个方法. 使用的springboot的依赖的版本低了,显式依赖1.33.0即可或高版本即可.</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.yaml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>snakeyaml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不一定最新的就是最好的，酌情使用，这个已经超过使用的springboot的版本了，还是要考虑</p><h2 id="读写分离" tabindex="-1"><a class="header-anchor" href="#读写分离" aria-hidden="true">#</a> 读写分离</h2><p>sharding-sphere只是实现了读写分离，主从同步不由它来实现</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token tag">!READWRITE_SPLITTING</span>
  <span class="token key atrule">dataSources</span><span class="token punctuation">:</span>
    <span class="token key atrule">&lt;data_source_name&gt; (+)</span><span class="token punctuation">:</span> <span class="token comment"># 读写分离逻辑数据源名称</span>
       <span class="token key atrule">write_data_source_name</span><span class="token punctuation">:</span> <span class="token comment"># 写库数据源名称</span>
       <span class="token key atrule">read_data_source_names</span><span class="token punctuation">:</span> <span class="token comment"># 读库数据源名称，多个从数据源用逗号分隔</span>
       <span class="token key atrule">transactionalReadQueryStrategy (?)</span><span class="token punctuation">:</span> <span class="token comment"># 事务内读请求的路由策略，可选值：PRIMARY（路由至主库）、FIXED（同一事务内路由至固定数据源）、DYNAMIC（同一事务内路由至非固定数据源）。默认值：DYNAMIC</span>
       <span class="token key atrule">loadBalancerName</span><span class="token punctuation">:</span> <span class="token comment"># 负载均衡算法名称</span>
  
  <span class="token comment"># 负载均衡算法配置</span>
  <span class="token key atrule">loadBalancers</span><span class="token punctuation">:</span>
    <span class="token key atrule">&lt;load_balancer_name&gt; (+)</span><span class="token punctuation">:</span> <span class="token comment"># 负载均衡算法名称</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token comment"># 负载均衡算法类型</span>
      <span class="token key atrule">props</span><span class="token punctuation">:</span> <span class="token comment"># 负载均衡算法属性配置</span>
        <span class="token comment"># ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="maven版本5-2-1" tabindex="-1"><a class="header-anchor" href="#maven版本5-2-1" aria-hidden="true">#</a> maven版本5.2.1</h3><p>按照数据分片的maven配置即可</p><p>yml配置也较为简单,新建application-rw.yml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token comment"># 是否开启</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token comment"># 数据源（逻辑名字）</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> master<span class="token punctuation">,</span>slave
      <span class="token comment"># 配置数据源</span>
      <span class="token key atrule">master</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test_demo_master<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
      <span class="token key atrule">slave</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test_demo_slave<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
    <span class="token comment"># 分片的配置</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token key atrule">readwrite-splitting</span><span class="token punctuation">:</span>
        <span class="token key atrule">data-sources</span><span class="token punctuation">:</span>
          <span class="token key atrule">rw</span><span class="token punctuation">:</span> <span class="token comment">#逻辑哭可自行命名</span>
            <span class="token key atrule">static-strategy</span><span class="token punctuation">:</span>
              <span class="token key atrule">write-data-source-name</span><span class="token punctuation">:</span> master
              <span class="token key atrule">read-data-source-names</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> slave
            <span class="token key atrule">load-balancer-name</span><span class="token punctuation">:</span> round<span class="token punctuation">-</span>robin
            <span class="token key atrule">transactionalReadQueryStrategy</span><span class="token punctuation">:</span> PRIMARY
        <span class="token key atrule">load-balancers</span><span class="token punctuation">:</span>
          <span class="token key atrule">round-robin</span><span class="token punctuation">:</span>
            <span class="token comment"># 负载均衡策略类型，ROUND_ROBIN，RANDOM,WEIGHT,TRANSACTION_RANDOM</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> ROUND_ROBIN
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token comment"># 日志显示具体的SQL</span>
      <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>数据库</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>

test_demo_master
test_demo_slave

<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>

t_order
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="maven版本5-1-1" tabindex="-1"><a class="header-anchor" href="#maven版本5-1-1" aria-hidden="true">#</a> maven版本5.1.1</h3><p>上述配置yml如果直接拿来用的话会报错</p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>Factory method &#39;shardingSphereDataSource&#39; threw exception; nested exception is java.lang.NullPointerException</p></div><p>这是由于配置不对，导致无法读取数据源文件</p><p>修改配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">rw</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> Static
  <span class="token key atrule">props</span><span class="token punctuation">:</span>
    <span class="token key atrule">write-data-source-name</span><span class="token punctuation">:</span> master
    <span class="token key atrule">read-data-source-names</span><span class="token punctuation">:</span> slave
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完整配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token comment"># 是否开启</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token comment"># 数据源（逻辑名字）</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> master<span class="token punctuation">,</span>slave
      <span class="token comment"># 配置数据源</span>
      <span class="token key atrule">master</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test_demo_master<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
      <span class="token key atrule">slave</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test_demo_slave<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> 100uu100UU
        <span class="token key atrule">druid</span><span class="token punctuation">:</span>
          <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat
          <span class="token key atrule">initialSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minIdle</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
          <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
          <span class="token key atrule">validationQuery</span><span class="token punctuation">:</span> select &#39;x&#39;
          <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">maxOpenPreparedStatements</span><span class="token punctuation">:</span> <span class="token number">20</span>
    <span class="token comment"># 分片的配置</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token key atrule">readwrite-splitting</span><span class="token punctuation">:</span>
        <span class="token key atrule">data-sources</span><span class="token punctuation">:</span>
          <span class="token key atrule">rw</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> Static
            <span class="token key atrule">props</span><span class="token punctuation">:</span>
              <span class="token key atrule">write-data-source-name</span><span class="token punctuation">:</span> master
              <span class="token key atrule">read-data-source-names</span><span class="token punctuation">:</span> slave
            <span class="token key atrule">load-balancer-name</span><span class="token punctuation">:</span> round<span class="token punctuation">-</span>robin
            <span class="token key atrule">transactionalReadQueryStrategy</span><span class="token punctuation">:</span> PRIMARY
        <span class="token key atrule">load-balancers</span><span class="token punctuation">:</span>
          <span class="token key atrule">round-robin</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> ROUND_ROBIN
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token comment"># 日志显示具体的SQL</span>
      <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2>`,105),g={href:"https://github.com/xingchunjing/jingxc-spring-boot-starter",target:"_blank",rel:"noopener noreferrer"},y=n("li",null,[n("strong",null,"本文作者："),s(" 景兴春")],-1),h=n("strong",null,"本文链接：",-1),x={href:"https://www.jingxc.top/spring/sharding-sphere.html",target:"_blank",rel:"noopener noreferrer"},f=n("strong",null,"版权声明：",-1),_={href:"https://www.apache.org/licenses/LICENSE-2.0.html",target:"_blank",rel:"noopener noreferrer"};function w(S,I){const e=t("ExternalLinkIcon"),l=t("RouterLink");return c(),o("div",null,[d,k,n("p",null,[s("具体使用请参阅"),n("a",m,[s("中文官网"),a(e)])]),v,n("p",null,[s("还是本分区惯例，旨在快速集成，如需了解概念性知识点，请查阅分区"),a(l,{to:"/knowledge/"},{default:u(()=>[s("知识点")]),_:1})]),b,n("p",null,[s("总的来说Sharding-Shpere配置不难，难的是由于配置很容易写错，版本不一致导致配置也不近相同，所以在此梳理一下,如果自己是在不知道哪里错了，可到我的"),n("a",g,[s("主页找下载代码"),a(e)])]),n("ul",null,[y,n("li",null,[h,s(),n("a",x,[s("https://www.jingxc.top/spring/sharding-sphere.html"),a(e)])]),n("li",null,[f,s(" 本博客所有文章除特别声明外，均采用 "),n("a",_,[s("Apache License 2.0"),a(e)]),s(" 许可协议。转载请注明出处！")])])])}const N=i(r,[["render",w],["__file","sharding-sphere.html.vue"]]);export{N as default};
