import{_ as e,X as o,Y as c,Z as n,$ as s,a0 as t,a5 as p,E as l}from"./framework-608b3dd6.js";const i="/assets/images/java-google01.jpeg",u="/assets/images/java-google02.jpeg",r="/assets/images/gpt-google01.png",k={},d=p('<h1 id="google内购" tabindex="-1"><a class="header-anchor" href="#google内购" aria-hidden="true">#</a> google内购</h1><p>google支付需要在服务端记录并验证订单，防止伪造订单，这里记录一下服务端校验订单</p><p>Google Pay主要支付流程：</p><div class="hint-container info"><p class="hint-container-title">相关信息</p><ul><li>手机端向Java服务端发起支付，生成预订单，给手机端返回生成的订单号</li><li>手机端向Google发起支付（传入java服务端生成的订单号）</li><li>Google服务器将支付结果返回给手机端（因这边用到的是消耗型的产品，所以购买后必须要通知gp我已经消耗了这次交易）</li><li>手机端向Java服务端发送校验请求，校验通过后即可处理订单（服务端重试校验，发货，保证订单正常发货成功）</li></ul></div><h2 id="_1-创建服务账号" tabindex="-1"><a class="header-anchor" href="#_1-创建服务账号" aria-hidden="true">#</a> 1. 创建服务账号</h2>',5),v={href:"https://console.cloud.google.com",target:"_blank",rel:"noopener noreferrer"},m=n("li",null,"选择项目或者创建一个新的项目，为了区分和维护推荐创建个新的项目",-1),g=n("li",null,"选中项目后例如(Google-Pay) 创建服务帐户",-1),b=n("li",null,"在“ 服务帐户详细信息”下 ，键入服务帐户的名称，ID和描述，然后单击“ 创建”",-1),h=n("li",null,"可选：在“ 服务帐户权限”下 ，选择要授予服务帐户的IAM角色，然后单击继续",-1),f=n("li",null,"可选：在“ 授予用户对此服务帐户的访问权限”下 ，添加允许使用和管理该服务帐户的用户或组。",-1),y=n("li",null,"单击管理密钥，创建密钥 ，然后单击创建推荐生成json格式密钥。(服务账号的验证方式可用，不过google最新api已弃用，所以这个可能有问题)",-1),S=p('<div class="hint-container danger"><p class="hint-container-title">警告</p><p>服务账号的验证方式可用，不过google最新api已弃用，所以这个可能有问题</p></div><figure><img src="'+i+'" alt="服务账号" tabindex="0" loading="lazy"><figcaption>服务账号</figcaption></figure><h2 id="_2-google-play后台关联服务账号并授权" tabindex="-1"><a class="header-anchor" href="#_2-google-play后台关联服务账号并授权" aria-hidden="true">#</a> 2. Google Play后台关联服务账号并授权</h2><ul><li>进入Google Play 管理中心的API 权限页面</li><li>将 Google Play 开发者帐号关联到 Google Cloud 项目如（Google-Pay）</li><li>点击服务帐号下要向自己的服务帐号授予对 Cloud 项目的访问权限，这样它才能显示在Google Play管理后台</li><li>完成点击刷新，API 权限页面的“服务帐号”会自动刷新，您的服务帐号将随即列出。</li><li>点击授予api访问权和应用于哪个app(可以选择多个app)，为服务帐号提供相关操作所需的权限。</li></ul><div class="hint-container warning"><p class="hint-container-title">注意</p><p>必须先将 Google Play 开发者帐号关联到 Google Cloud 项目，然后才能访问 Google Play Developer API。在大多数情况下，我们建议您为自己的 Google Play 开发者帐号新建一个专用的 Google Cloud 项目，不过您也可以关联现有项目。请注意，每个 Google Play 开发者帐号只能关联到一个 Google Cloud 项目。如果您的同一个 Google Play 开发者帐号中有多个应用，这些应用必须都共用同一个 Google Cloud 项目。</p></div>',5),_={href:"https://blog.csdn.net/weixin_39222112/article/details/120068129",target:"_blank",rel:"noopener noreferrer"},w=p(`<h2 id="_3-获取凭证" tabindex="-1"><a class="header-anchor" href="#_3-获取凭证" aria-hidden="true">#</a> 3. 获取凭证</h2><p>由于要链接Google Play中的项目所以直接导入 androidpublisher，这里已经包含了部分鉴权相关的api，后续还需导入其他依赖包</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.apis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>google-api-services-androidpublisher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>v3-rev20211125-1.32.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-如何查找maven依赖的版本" tabindex="-1"><a class="header-anchor" href="#_3-1-如何查找maven依赖的版本" aria-hidden="true">#</a> 3.1 如何查找maven依赖的版本：</h3><hr>`,5),I={href:"https://mvnrepository.com/",target:"_blank",rel:"noopener noreferrer"},P={href:"https://console.cloud.google.com",target:"_blank",rel:"noopener noreferrer"},j={href:"https://developers.google.com/android-publisher/libraries?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},q={href:"https://developers.google.com/api-client-library/java/apis/androidpublisher/v3?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},O={href:"https://github.com/googleapis/google-api-java-client-services/tree/main/clients/google-api-services-androidpublisher/v3",target:"_blank",rel:"noopener noreferrer"},T=n("p",null,"上面这个过程有点复杂，不过记录一下下次自己找东西就方便多了，外文文档一不留神就不清楚到哪去找东西了",-1),A=n("h3",{id:"_3-2-获取凭证-客户端凭证",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-2-获取凭证-客户端凭证","aria-hidden":"true"},"#"),s(" 3.2 获取凭证(客户端凭证)")],-1),G=n("hr",null,null,-1),x=n("div",{class:"hint-container info"},[n("p",{class:"hint-container-title"},"相关信息"),n("p",null,"之前的GoogleCredential也会在后续被废弃，服务账号验证的方式不知道后续会怎样，所以还是要能找到最新的文档，接下来的方式是获取客户端凭证的流程")],-1),C={href:"https://developers.google.com/android-publisher?hl=zh_CN",target:"_blank",rel:"noopener noreferrer"},R={href:"https://developers.google.com/identity/protocols/oauth2?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},N={href:"https://developers.google.com/api-client-library/java/google-api-java-client/oauth2?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},E={href:"https://googleapis.dev/java/google-api-client/latest/com/google/api/client/googleapis/auth/oauth2/GoogleCredential.html",target:"_blank",rel:"noopener noreferrer"},D=n("p",null,"直接使用文档中的代码，发现还需要导入很多的包，这些包去哪找？",-1),J={href:"https://developers.google.com/api-client-library/java/google-api-java-client/oauth2?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},F=n("strong",null,"目的",-1),L={href:"https://googleapis.dev/java/google-api-client/latest/com/google/api/client/googleapis/auth/oauth2/GoogleCredential.html",target:"_blank",rel:"noopener noreferrer"},U={href:"https://developers.google.com/api-client-library/java/google-oauth-java-client/oauth2?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},B={href:"https://developers.google.com/api-client-library/java/google-oauth-java-client/oauth2?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},z={href:"https://developers.google.com/api-client-library/java/google-oauth-java-client/reference/1.20.0/com/google/api/client/auth/oauth2/package-summary.html?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},H={href:"https://developers.google.com/api-client-library/java/google-oauth-java-client/setup?hl=zh-cn#google-oauth-client",target:"_blank",rel:"noopener noreferrer"},V={href:"https://developers.google.com/api-client-library/java/google-oauth-java-client/setup?hl=zh-cn#google-oauth-client",target:"_blank",rel:"noopener noreferrer"},M=p(`<div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--最终使用版本 1.32.1--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.oauth-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>google-oauth-client-java6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.30.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--最终使用版本 1.32.1--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.oauth-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>google-oauth-client-jetty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.30.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--这个依赖文档中没有，不过确实用到了，我在其他文档中看到google-api-client-jackson2的2.0.0版本，不过那个有问题，所以还是按这个用吧 --&gt;</span>
<span class="token comment">&lt;!--最终使用版本 1.30.4--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.api-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>google-api-client-jackson2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.30.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成代码（已安装应用客户端方式，需要用户授权）：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Credential</span> <span class="token function">authorize</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientSecretsJson<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">JsonFactory</span> jsonFactory <span class="token operator">=</span> <span class="token class-name">JacksonFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpTransport</span> transport <span class="token operator">=</span> <span class="token class-name">GoogleNetHttpTransport</span><span class="token punctuation">.</span><span class="token function">newTrustedTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InputStreamReader</span> isr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>clientSecretsJson<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GoogleClientSecrets</span> clientSecrets <span class="token operator">=</span> <span class="token class-name">GoogleClientSecrets</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>jsonFactory<span class="token punctuation">,</span> isr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">GoogleAuthorizationCodeFlow</span> flow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoogleAuthorizationCodeFlow<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>
            transport<span class="token punctuation">,</span> jsonFactory<span class="token punctuation">,</span> clientSecrets<span class="token punctuation">,</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token class-name">AndroidPublisherScopes</span><span class="token punctuation">.</span><span class="token constant">ANDROIDPUBLISHER</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationCodeInstalledApp</span><span class="token punctuation">(</span>flow<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LocalServerReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container danger"><p class="hint-container-title">警告</p><p>到了这一步，运行后显示java.lang.IllegalArgumentException</p></div><p>报错是在</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">GoogleClientSecrets</span> clientSecrets <span class="token operator">=</span> <span class="token class-name">GoogleClientSecrets</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>jsonFactory<span class="token punctuation">,</span> isr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看源码才知道， load需要加载参数installed或者web</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>上面下载的json文件是服务端的凭证，之前使用下面的代码是没问题的，不过GoogleCredential已弃用，服务账号的凭证与官方示例客户端验证不匹配，需要下载 OAuth 2.0 客户端 ID（凭证），一定要换</p></div><p>这里也贴一下之前的服务账号验证的方式</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//这是之前的服务账号验证的方式，新的api中是被弃用的，但是官方文档中还是这么用的示例....，也许后续会更新吧</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">GoogleCredential</span> <span class="token function">authorizeServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">HttpTransport</span> transport <span class="token operator">=</span> <span class="token class-name">GoogleNetHttpTransport</span><span class="token punctuation">.</span><span class="token function">newTrustedTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JsonFactory</span> jsonFactory <span class="token operator">=</span> <span class="token class-name">JacksonFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ByteArrayInputStream</span> byteArrayInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>clientSecretsJson<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//已弃用</span>
    <span class="token class-name">GoogleCredential</span> readJsonFile <span class="token operator">=</span> <span class="token class-name">GoogleCredential</span><span class="token punctuation">.</span><span class="token function">fromStream</span><span class="token punctuation">(</span>byteArrayInputStream<span class="token punctuation">,</span> transport<span class="token punctuation">,</span> jsonFactory<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">createScoped</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token class-name">AndroidPublisherScopes</span><span class="token punctuation">.</span><span class="token constant">ANDROIDPUBLISHER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">GoogleCredential</span> credential <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoogleCredential<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTransport</span><span class="token punctuation">(</span>readJsonFile<span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setJsonFactory</span><span class="token punctuation">(</span>readJsonFile<span class="token punctuation">.</span><span class="token function">getJsonFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setServiceAccountId</span><span class="token punctuation">(</span>readJsonFile<span class="token punctuation">.</span><span class="token function">getServiceAccountId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setServiceAccountScopes</span><span class="token punctuation">(</span>readJsonFile<span class="token punctuation">.</span><span class="token function">getServiceAccountScopes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//.setServiceAccountUser(&quot;hospital-billing-manager@api-7965197382587815639-857758.iam.gserviceaccount.com&quot;)</span>
        <span class="token punctuation">.</span><span class="token function">setServiceAccountPrivateKey</span><span class="token punctuation">(</span>readJsonFile<span class="token punctuation">.</span><span class="token function">getServiceAccountPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> credential<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说实话到这一步我已经不想弄了,结果一看很清楚，过程无法言述，哎.......</p><p>这回写个main方法执行一下，果然不出我所料，还有问题</p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>这回是java.lang.NoSuchMethodError: org.eclipse.jetty.server.Connector.setHost</p></div><p>查看源码发现是 new LocalServerReceiver()出得问题，竟然没有 setHost方法， 不得不说就很强，头发掉很多，弄了半天我以为是什么写错了呢，后来决定换下依赖的版本，全都换成1.32.1，这回代码直接出错了， 这个JacksonFactory.getDefaultInstance();方法没有 了，所以有单独把google-api-client-jackson2换成1.30.4，这回可以了，代码没报错，运行也没报错，能弹出授权页面，但是授权页面显示：</p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>错误 400： redirect_uri_mismatch，这个问题是由于我的是测试项目，需要授权回调地址，所以redirect_uri得配制成自己的，得了，整个方法弄的还不如我自己写一个http请求来的快呢</p></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//添加配置，开发者后台配置OAuth 2.0 客户端 ID</span>
<span class="token class-name">LocalServerReceiver</span> localServerReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalServerReceiver<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">8092</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">setCallbackPath</span><span class="token punctuation">(</span><span class="token string">&quot;/jingxc/google/google-callback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+u+`" alt="客户端凭证" tabindex="0" loading="lazy"><figcaption>客户端凭证</figcaption></figure><p>整个可以运行的代码是：运行会有堆栈溢出，暂时没时间管这个，先将就着往下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jxc<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span></span><span class="token class-name">Credential</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span>java6<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationCodeInstalledApp</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span>jetty<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span></span><span class="token class-name">LocalServerReceiver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span></span><span class="token class-name">GoogleAuthorizationCodeFlow</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span></span><span class="token class-name">GoogleClientSecrets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>javanet<span class="token punctuation">.</span></span><span class="token class-name">GoogleNetHttpTransport</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpTransport</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JsonFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>json<span class="token punctuation">.</span>jackson2<span class="token punctuation">.</span></span><span class="token class-name">JacksonFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>util<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">FileDataStoreFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>services<span class="token punctuation">.</span>androidpublisher<span class="token punctuation">.</span></span><span class="token class-name">AndroidPublisherScopes</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>jxc<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">GooglePayService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStreamReader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">GeneralSecurityException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GooglePayServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GooglePayService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>File</span> <span class="token constant">DATA_STORE_DIR</span> <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>File</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;user.home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;.googlepay/pay_sample&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Credential</span> <span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token class-name">JsonFactory</span> jsonFactory <span class="token operator">=</span> <span class="token class-name">JacksonFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpTransport</span> transport <span class="token operator">=</span> <span class="token class-name">GoogleNetHttpTransport</span><span class="token punctuation">.</span><span class="token function">newTrustedTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//InputStreamReader isr = new InputStreamReader(IOUtils.toInputStream(clientSecretsJson, &quot;UTF-8&quot;));</span>
        <span class="token class-name">InputStreamReader</span> isr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">GooglePayServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;./client_secrets.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GoogleClientSecrets</span> clientSecrets <span class="token operator">=</span> <span class="token class-name">GoogleClientSecrets</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>jsonFactory<span class="token punctuation">,</span> isr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileDataStoreFactory</span> dataStoreFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileDataStoreFactory</span><span class="token punctuation">(</span><span class="token constant">DATA_STORE_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GoogleAuthorizationCodeFlow</span> flow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoogleAuthorizationCodeFlow<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>
                transport<span class="token punctuation">,</span> jsonFactory<span class="token punctuation">,</span> clientSecrets<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token class-name">AndroidPublisherScopes</span><span class="token punctuation">.</span><span class="token constant">ANDROIDPUBLISHER</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalServerReceiver</span> localServerReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalServerReceiver<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">8092</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCallbackPath</span><span class="token punctuation">(</span><span class="token string">&quot;/jingxc/google/google-callback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationCodeInstalledApp</span><span class="token punctuation">(</span>flow<span class="token punctuation">,</span> localServerReceiver<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Credential</span> credential <span class="token operator">=</span> <span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>到这就可以显示跳转页面，但和我想要的不一样啊，我想用服务账号似的直接获取权限，我找了好多地方，也没有看到服务凭证还有那些新的不被弃用的方法，实在是找不出来了，不找了，我也问了gpt也是给出不建议用服务账号的方式</p></div><p>现在两种方式都尝试了一下，觉得怎样合适就怎样来吧</p><p>顺便这里说下之后会专门写一篇不用官方api的方式，感觉使用api反而比较乱</p><p>若果想消除服务账号验证的弃用标记，可以低版本的maven，我试了一下最高使用1.28.0之后就有弃用标记了</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--本文写时官网版本是2.0.0 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.api-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>google-api-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.28.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>特别说明：在这我还特意去请教了一下gpt,我问的是google登陆的授权，道理一样，不同的授权就是scope参数不同</p></div><figure><img src="`+r+`" alt="gpt咨询" tabindex="0" loading="lazy"><figcaption>gpt咨询</figcaption></figure><h2 id="_4-查询订单信息" tabindex="-1"><a class="header-anchor" href="#_4-查询订单信息" aria-hidden="true">#</a> 4. 查询订单信息</h2><p>查询订单信息，上面的准备工作已经基本完成，可以直接完成代码了，伪代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token comment">// 参数详细说明:</span>
    <span class="token class-name">String</span> signtureData <span class="token operator">=</span> <span class="token string">&quot;安卓上报的订单数据&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> signture <span class="token operator">=</span> <span class="token string">&quot;安卓上报的签名&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> publicKey <span class="token operator">=</span> <span class="token string">&quot;订单数据验签公钥&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name">JSONObject</span> parseObject <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>signtureData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> productId <span class="token operator">=</span> parseObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;productId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在谷歌后台定义的商品id</span>
    <span class="token class-name">String</span> packageName <span class="token operator">=</span> parseObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;packageName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//安卓apk包名</span>
    <span class="token class-name">String</span> purchaseToken <span class="token operator">=</span> parseObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;purchaseToken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//安卓上报的token</span>
    <span class="token keyword">int</span> purchaseState <span class="token operator">=</span> parseObject<span class="token punctuation">.</span><span class="token function">getIntValue</span><span class="token punctuation">(</span><span class="token string">&quot;purchaseState&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//订单状态</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>purchaseState <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//TODO 订单未完成付款</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Credential</span> credential <span class="token operator">=</span> <span class="token function">authorizeServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpTransport</span> transport <span class="token operator">=</span> <span class="token class-name">GoogleNetHttpTransport</span><span class="token punctuation">.</span><span class="token function">newTrustedTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AndroidPublisher</span> publisher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>transport<span class="token punctuation">,</span> <span class="token class-name">JacksonFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            credential<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setApplicationName</span><span class="token punctuation">(</span><span class="token string">&quot;uu_oversea_pay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Purchases<span class="token punctuation">.</span>Products</span> products <span class="token operator">=</span> publisher<span class="token punctuation">.</span><span class="token function">purchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">products</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Purchases<span class="token punctuation">.</span>Subscriptions</span> subscribes <span class="token operator">=</span> publisher<span class="token punctuation">.</span><span class="token function">purchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscriptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> doCheck <span class="token operator">=</span> <span class="token constant">RSA</span><span class="token punctuation">.</span><span class="token function">doCheck</span><span class="token punctuation">(</span>signtureData<span class="token punctuation">,</span> signture<span class="token punctuation">,</span> publicKey<span class="token punctuation">,</span> <span class="token string">&quot;RSA1&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// https://developers.google.com/android-publisher/api-ref/purchases/products/get</span>
    <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Purchases<span class="token punctuation">.</span>Products<span class="token punctuation">.</span>Get</span> product <span class="token operator">=</span> products<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> productId<span class="token punctuation">,</span> purchaseToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Purchases<span class="token punctuation">.</span>Subscriptions<span class="token punctuation">.</span>Get</span> subscribe <span class="token operator">=</span> subscribes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> productId<span class="token punctuation">,</span>
            purchaseToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取订单信息</span>
    <span class="token comment">// https://developers.google.com/android-publisher/api-ref/purchases/products</span>
    <span class="token comment">// 通过consumptionState, purchaseState可以判断订单的状态</span>
    <span class="token class-name">String</span> purchaseOrderId <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> payType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> payType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ProductPurchase</span> purchase <span class="token operator">=</span> product<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        purchaseOrderId <span class="token operator">=</span> purchase<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        purchaseState <span class="token operator">=</span> purchase<span class="token punctuation">.</span><span class="token function">getPurchaseState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>purchaseState <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO 订单未付款</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">SubscriptionPurchase</span> purchase <span class="token operator">=</span> subscribe<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> expiryTimeMillis <span class="token operator">=</span> purchase<span class="token punctuation">.</span><span class="token function">getExpiryTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;</span> expiryTimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO 订单已过订阅期限</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        purchaseOrderId <span class="token operator">=</span> purchase<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//TODO 更改订单状态</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回的数据信息：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>

	<span class="token property">&quot;purchaseTimeMillis&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1682575200000&quot;</span><span class="token punctuation">,</span><span class="token comment">//购买产品的时间，自纪元（1970 年 1 月 1 日）以来的毫秒数。</span>
	<span class="token property">&quot;purchaseState&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//订单的购买状态。可能的值为：0. 已购买 1. 已取消 2. 待定</span>
	<span class="token property">&quot;consumptionState&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//产品的消费状态。可能的值为： 0. 尚未消耗 1. 已消耗</span>
	<span class="token property">&quot;developerPayload&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GPA.3398-6726-1036-80298&quot;</span><span class="token punctuation">,</span><span class="token comment">//google订单号</span>
	<span class="token property">&quot;purchaseType&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">&quot;acknowledgementState&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;androidpublisher#productPurchase&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;obfuscatedExternalAccountId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SDK2204180944530041&quot;</span><span class="token punctuation">,</span><span class="token comment">//上面客户支付时的透传字段，google指导是用来存放用户信息的，不能过长，否则客户端不能支付</span>
	<span class="token property">&quot;obfuscatedExternalProfileId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;regionCode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HK&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-退款数据查询" tabindex="-1"><a class="header-anchor" href="#_5-退款数据查询" aria-hidden="true">#</a> 5. 退款数据查询</h2><p>退款信息查询，该功能是补充功能，正常来说用不到，不过可以作为当webhook信息接收出现问题时作为补充选项</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">googleRefundOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">GoogleCredential</span> credential <span class="token operator">=</span> <span class="token function">authorizeServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> packageName <span class="token operator">=</span> <span class="token string">&quot;安卓apk的包名&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpTransport</span> transport <span class="token operator">=</span> <span class="token class-name">GoogleNetHttpTransport</span><span class="token punctuation">.</span><span class="token function">newTrustedTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JacksonFactory</span> defaultInstance <span class="token operator">=</span> <span class="token class-name">JacksonFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AndroidPublisher</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>transport<span class="token punctuation">,</span> defaultInstance<span class="token punctuation">,</span> credential<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setApplicationName</span><span class="token punctuation">(</span><span class="token string">&quot;uu_oversea_pay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取google list对象</span>
    <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Purchases<span class="token punctuation">.</span>Voidedpurchases<span class="token punctuation">.</span>List</span> voidPurchaseList <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">purchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">voidedpurchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置查询参数</span>
    voidPurchaseList<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span><span class="token function">getDaysBeforeUnixTimeStampMinute</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//一天</span>
    <span class="token comment">// 执行查询</span>
    <span class="token class-name">VoidedPurchasesListResponse</span> response <span class="token operator">=</span> voidPurchaseList<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoidedPurchase</span><span class="token punctuation">&gt;</span></span> voidedPurchases <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getVoidedPurchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voidedPurchases <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//TODO 没有退款</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取分页tokenPagination</span>
    <span class="token class-name">TokenPagination</span> tokenPagination <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getTokenPagination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tokenPagination <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置查询token 重新执行查询 查询下一页</span>
        voidPurchaseList<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>tokenPagination<span class="token punctuation">.</span><span class="token function">getNextPageToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VoidedPurchasesListResponse</span> newResponse <span class="token operator">=</span> voidPurchaseList<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voidedPurchases<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>newResponse<span class="token punctuation">.</span><span class="token function">getVoidedPurchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenPagination <span class="token operator">=</span> newResponse<span class="token punctuation">.</span><span class="token function">getTokenPagination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VoidedPurchase</span> voidedPurchase <span class="token operator">:</span> voidedPurchases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> orderId <span class="token operator">=</span> voidedPurchase<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO 处理相关退款账号和设备</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-webhook" tabindex="-1"><a class="header-anchor" href="#_6-webhook" aria-hidden="true">#</a> 6. webhook</h2><div class="hint-container tip"><p class="hint-container-title">提示</p><p>要接收 Google Play 发送的退款通知，需要在 Google Play Developer Console 中配置并验证一个 Webhook URL。Webhook URL 是一个接收 POST 请求的 URL，当用户退款时，Google Play 会向这个 URL 发送退款通知。以下是配置 Webhook URL 的步骤：</p></div><ol><li>打开 Google Play Developer Console，进入你的应用程序的管理页面。</li><li>在左侧导航菜单中，选择“商店设置”&gt;“开发者帐户”。</li><li>单击“创建新的 API 密钥”，并按照指示生成 API 密钥。</li><li>在左侧导航菜单中，选择“商店设置”&gt;“API 访问”。</li><li>单击“创建新的 Webhook”，输入 Webhook URL，选择要接收的通知类型（例如，购买、退款、续订等），然后单击“创建 Webhook”。</li><li>如果你的 Webhook URL 使用了 SSL 加密，则需要上传 SSL 证书。</li><li>单击“保存”。</li></ol><div class="hint-container warning"><p class="hint-container-title">注意</p><p>为了验证 Webhook URL 的有效性，Google Play 会向该 URL 发送一个验证请求。需要在 Webhook URL 中编写代码来处理验证请求，并返回一个特定格式的响应。验证请求的详细信息可以在 Google Play Developer Console 中找到。</p></div><p>完成以上步骤后，当有用户退款时，Google Play 会向你配置的 Webhook URL 发送一个 POST 请求，请求包含有关退款的详细信息。你可以使用这些信息来更新你的应用程序状态，并根据需要执行其他相关操作。</p><h2 id="_7-订阅的订单" tabindex="-1"><a class="header-anchor" href="#_7-订阅的订单" aria-hidden="true">#</a> 7. 订阅的订单</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">googleSubscribeOrder</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span>
    <span class="token class-name">JSONObject</span> paramJson <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> paramStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        paramJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span><span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>paramStr<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JSONObject</span> msgJson <span class="token operator">=</span> paramJson<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> msgJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> developerNotificationStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> developerNotificationJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>developerNotificationStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> packageName <span class="token operator">=</span> developerNotificationJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;packageName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> subscriptionNotificationJson <span class="token operator">=</span> developerNotificationJson
                <span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">&quot;subscriptionNotification&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> purchaseToken <span class="token operator">=</span> subscriptionNotificationJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;purchaseToken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> subscriptionId <span class="token operator">=</span> subscriptionNotificationJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;subscriptionId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * notificationType int 通知的类型。它可以具有以下值： (1)
         * SUBSCRIPTION_RECOVERED - 从帐号保留状态恢复了订阅。 (2)
         * SUBSCRIPTION_RENEWED - 续订了处于活动状态的订阅。 (3)
         * SUBSCRIPTION_CANCELED - 自愿或非自愿地取消了订阅。如果是自愿取消，在用户取消时发送。 (4)
         * SUBSCRIP￼￼TION_PURCHASED - 购买了新的订阅。 (5) SUBSCRIPTION_ON_HOLD
         * - 订阅已进入帐号保留状态（如已启用）。 (6) SUBSCRIPTION_IN_GRACE_PERIOD -
         * 订阅已进入宽限期（如已启用）。 (7) SUBSCRIPTION_RESTARTED -
         * 用户已通过“Play”&gt;“帐号”&gt;“订阅”重新激活其订阅（需要选择使用订阅恢复功能）。 (8)
         * SUBSCRIPTION_PRICE_CHANGE_CONFIRMED - 用户已成功确认订阅价格变动。 (9)
         * SUBSCRIPTION_DEFERRED - 订阅的续订时间点已延期。 (10) SUBSCRIPTION_PAUSED
         * - 订阅已暂停。 (11) SUBSCRIPTION_PAUSE_SCHEDULE_CHANGED -
         * 订阅暂停计划已更改。 (12) SUBSCRIPTION_REVOKED - 用户在有效时间结束前已撤消订阅。 (13)
         * SUBSCRIPTION_EXPIRED - 订阅已过期。
         */</span>
        <span class="token keyword">int</span> notificationType <span class="token operator">=</span> subscriptionNotificationJson<span class="token punctuation">.</span><span class="token function">getIntValue</span><span class="token punctuation">(</span><span class="token string">&quot;notificationType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> notificationType<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">GoogleCredential</span> credential <span class="token operator">=</span> <span class="token function">authorizeServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">HttpTransport</span> transport <span class="token operator">=</span> <span class="token class-name">GoogleNetHttpTransport</span><span class="token punctuation">.</span><span class="token function">newTrustedTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">AndroidPublisher</span> publisher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>transport<span class="token punctuation">,</span>
                    <span class="token class-name">JacksonFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> credential<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setApplicationName</span><span class="token punctuation">(</span><span class="token string">&quot;uu_oversea_pay&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Purchases<span class="token punctuation">.</span>Subscriptions</span> subscribes <span class="token operator">=</span> publisher<span class="token punctuation">.</span><span class="token function">purchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscriptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">AndroidPublisher<span class="token punctuation">.</span>Purchases<span class="token punctuation">.</span>Subscriptions<span class="token punctuation">.</span>Get</span> subscribe <span class="token operator">=</span> subscribes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> subscriptionId<span class="token punctuation">,</span>
                    purchaseToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SubscriptionPurchase</span> purchase <span class="token operator">=</span> subscribe<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> expiryTimeMillis <span class="token operator">=</span> purchase<span class="token punctuation">.</span><span class="token function">getExpiryTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;</span> expiryTimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//已过订阅期限</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> purchaseOrderId <span class="token operator">=</span> purchase<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//TODO 续订</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>google支付相关的问题就介绍到这...</p><p>后记：我会在写一篇curl的流程介绍，那样不受api版本限制，比较自由灵活</p>`,43),W=n("li",null,[n("strong",null,"本文作者："),s(" 景兴春")],-1),K=n("strong",null,"本文链接：",-1),X={href:"https://www.jingxc.top/back/payment/java-google.html",target:"_blank",rel:"noopener noreferrer"},Y=n("strong",null,"版权声明：",-1),Z={href:"https://www.apache.org/licenses/LICENSE-2.0.html",target:"_blank",rel:"noopener noreferrer"};function $(Q,nn){const a=l("ExternalLinkIcon");return o(),c("div",null,[d,n("ul",null,[n("li",null,[s("打开地址： "),n("a",v,[s("https://console.cloud.google.com"),t(a)])]),m,g,b,h,f,y]),S,n("p",null,[s("以上参考： "),n("a",_,[s("https://blog.csdn.net/weixin_39222112/article/details/120068129"),t(a)])]),w,n("ul",null,[n("li",null,[s("简单的方法：直接在在该网址上查询即可 "),n("a",I,[s("https://mvnrepository.com/"),t(a)]),s(" ，不过版本可能不是最新，选择一个使用最多的版本即可")]),n("li",null,[s("稍微复杂一点（正式一点），访问开发者后台 "),n("a",P,[s("https://console.cloud.google.com"),t(a)]),s(" ，右侧导航栏API和服务->库，搜索androidpublisher，进入api库里面，查看教程和文档，链接跳转到官方文档中，在使用入门最下面客户端库， 请参阅 "),n("a",j,[s("客户端库和代码示例"),t(a)]),s(" 点解链接进入 "),n("a",q,[s("适用于 Java 的 Google API 客户端库"),t(a)]),s(" 即可跳转到官方的git仓库 "),n("a",O,[s("https://github.com/googleapis/google-api-java-client-services/tree/main/clients/google-api-services-androidpublisher/v3"),t(a)])])]),T,A,G,x,n("ul",null,[n("li",null,[s("在刚才（"),n("a",C,[s("进入api库里面，查看教程和文档，链接跳转到 官方文档 中"),t(a)]),s("）这一步中选择左侧导航栏： 使用入门")]),n("li",null,[s("本页内容中： 使用 OAuth 客户端，"),n("a",R,[s("点击链接OAuth"),t(a)]),s("，进入到 使用 OAuth 2.0 访问 Google API")]),n("li",null,[s("本页内容最下面：客户端库-- "),n("a",N,[s("适用于 Java 的 Google API 客户端库"),t(a)]),s(" 点击进入")]),n("li",null,[s("本页内容中：已安装应用方式（服务账号的方式老是显示 "),n("a",E,[s("GoogleCredential"),t(a)]),s(" 被弃用 ）：官方给的示例代码，修改获得自己的代码")])]),D,n("p",null,[s("根据"),n("a",J,[s("文档"),t(a)]),s("页面最上面概览中介绍： "),F,s(" ：本文档介绍了如何使用 "),n("a",L,[s("GoogleCredential"),t(a)]),s(" 实用程序类对 Google 服务进行 OAuth 2.0 授权。如需了解我们提供的通用 OAuth 2.0 函数，请参阅 "),n("a",U,[s("OAuth 2.0 和 Java 版 Google OAuth 客户端库"),t(a)]),s(" 。")]),n("p",null,[s("我们需要到 "),n("a",B,[s("OAuth2.0和Java版Google OAuth客户端库这里面找"),t(a)]),s(" 里面有个 "),n("a",z,[s("com.google.api.client.auth.oauth2"),t(a)]),s(" （来自 "),n("a",H,[s("google-oauth-client"),t(a)]),s(" ）")]),n("p",null,[s("点击进入 "),n("a",V,[s("google-oauth-client"),t(a)]),s(" 使用到了里面的这些依赖")]),M,n("ul",null,[W,n("li",null,[K,s(),n("a",X,[s("https://www.jingxc.top/back/payment/java-google.html"),t(a)])]),n("li",null,[Y,s(" 本博客所有文章除特别声明外，均采用 "),n("a",Z,[s("Apache License 2.0"),t(a)]),s(" 许可协议。转载请注明出处！")])])])}const an=e(k,[["render",$],["__file","java-google.html.vue"]]);export{an as default};
